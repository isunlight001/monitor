<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘Šè­¦è®°å½• - åŸºé‡‘ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/css/layui.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .layui-layout-admin .layui-header {
            background-color: #23262E;
        }
        .layui-layout-admin .layui-side {
            background-color: #393D49;
        }
        .layui-layout-admin .layui-logo {
            color: #fff;
            font-weight: bold;
        }
        .layui-card {
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .layui-table {
            margin: 0;
        }
        .layui-table th {
            background-color: #f8f9fa;
        }
        .alert-high {
            color: #FF5722;
            font-weight: bold;
        }
        .alert-medium {
            color: #FFB800;
            font-weight: bold;
        }
        .alert-low {
            color: #009688;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="layui-layout layui-layout-admin">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="layui-header">
            <div class="layui-logo">ğŸ“ˆ åŸºé‡‘ç›‘æ§ç³»ç»Ÿ</div>
            <!-- å¤´éƒ¨åŒºåŸŸå·¦ä¾§ -->
            <ul class="layui-nav layui-layout-left">
                <li class="layui-nav-item"><a href="index.html">é¦–é¡µ</a></li>
            </ul>
            <!-- å¤´éƒ¨åŒºåŸŸå³ä¾§ -->
            <ul class="layui-nav layui-layout-right" id="userInfoNav">
                <li class="layui-nav-item">
                    <a href="javascript:;" id="userNameLink">
                        <img src="//tva1.sinaimg.cn/crop.0.0.118.118.180/5db11ff4gw1e77d3nqrv8j203k03kweg.jpg" class="layui-nav-img">
                        <span id="currentUserName">æ¸¸å®¢</span>
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:void(0);" onclick="logout()">é€€å‡ºç™»å½•</a></dd>
                    </dl>
                </li>
            </ul>
        </div>

        <!-- å·¦ä¾§å¯¼èˆªåŒºåŸŸ -->
        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- å·¦ä¾§å¯¼èˆªåŒºåŸŸ -->
                <ul class="layui-nav layui-nav-tree" lay-filter="navTree">
                    <li class="layui-nav-item">
                        <a href="index.html">é¦–é¡µ</a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">åŸºé‡‘ç›‘æ§</a>
                        <dl class="layui-nav-child">
                            <dd><a href="fund-monitor.html">ğŸ“Š åŸºé‡‘ç›‘æ§</a></dd>
                            <dd><a href="index-data.html">ğŸ’¹ æŒ‡æ•°æ•°æ®</a></dd>
                            <dd><a href="fund-backtest.html">ğŸ§ª åŸºé‡‘å›æµ‹</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="javascript:;">å‘Šè­¦ç®¡ç†</a>
                        <dl class="layui-nav-child">
                            <dd><a href="alert-records.html">ğŸ”” å‘Šè­¦è®°å½•</a></dd>
                            <dd><a href="notification-test.html">ğŸ“§ é€šçŸ¥æµ‹è¯•</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">ç³»ç»Ÿç®¡ç†</a>
                        <dl class="layui-nav-child">
                            <dd><a href="email-recipient-management.html">ğŸ‘¥ é‚®ä»¶æ¥æ”¶äºº</a></dd>
                            <dd><a href="system-config.html">âš™ï¸ ç³»ç»Ÿé…ç½®</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">AIåŠŸèƒ½</a>
                        <dl class="layui-nav-child">
                            <dd><a href="ai-test.html">ğŸ¤– AIæµ‹è¯•</a></dd>
                            <dd><a href="fund-report-test.html">ğŸ“ˆ æŠ¥å‘Šæµ‹è¯•</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="stock-management.html">ğŸ“ˆ è‚¡ç¥¨ç®¡ç†</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- å†…å®¹ä¸»ä½“åŒºåŸŸ -->
        <div class="layui-body">
            <!-- å†…å®¹åŒº -->
            <div style="padding: 15px;">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <i class="layui-icon layui-icon-bell"></i> å‘Šè­¦è®°å½•
                        <button class="layui-btn layui-btn-sm layui-btn-normal" style="float: right;" onclick="refreshData()">
                            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                    <div class="layui-card-body">
                        <form class="layui-form" lay-filter="searchForm">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">åŸºé‡‘ä»£ç </label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="fundCode" placeholder="è¯·è¾“å…¥åŸºé‡‘ä»£ç " autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">åŸºé‡‘åç§°</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="fundName" placeholder="è¯·è¾“å…¥åŸºé‡‘åç§°" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">å‘Šè­¦çº§åˆ«</label>
                                    <div class="layui-input-inline">
                                        <select name="alertLevel">
                                            <option value="">è¯·é€‰æ‹©å‘Šè­¦çº§åˆ«</option>
                                            <option value="HIGH">é«˜é£é™©</option>
                                            <option value="MEDIUM">ä¸­é£é™©</option>
                                            <option value="LOW">ä½é£é™©</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">æ—¶é—´èŒƒå›´</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="dateRange" placeholder="è¯·é€‰æ‹©æ—¶é—´èŒƒå›´" autocomplete="off" class="layui-input" id="dateRange">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" lay-submit lay-filter="searchSubmit">
                                        <i class="layui-icon layui-icon-search"></i> æŸ¥è¯¢
                                    </button>
                                    <button type="reset" class="layui-btn layui-btn-primary">
                                        <i class="layui-icon layui-icon-refresh"></i> é‡ç½®
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <table class="layui-hide" id="alertTable" lay-filter="alertTable"></table>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="layui-card" style="margin-top: 20px;">
                    <div class="layui-card-header">
                        <i class="layui-icon layui-icon-util"></i> æ“ä½œé¢æ¿
                    </div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <button class="layui-btn layui-btn-danger layui-btn-fluid" onclick="clearAllAlerts()">
                                    <i class="layui-icon layui-icon-delete"></i> æ¸…ç©ºæ‰€æœ‰å‘Šè­¦
                                </button>
                            </div>
                            <div class="layui-col-md3">
                                <button class="layui-btn layui-btn-normal layui-btn-fluid" onclick="exportData()">
                                    <i class="layui-icon layui-icon-export"></i> å¯¼å‡ºæ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å›ºå®šåŒºåŸŸ -->
        <div class="layui-footer footer">
            Â© 2025 åŸºé‡‘ç›‘æ§ç³»ç»Ÿ - ä¸“ä¸šçš„åŸºé‡‘æ•°æ®åˆ†æå¹³å°
        </div>
    </div>

    <script type="text/html" id="alertToolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="clearAll">æ¸…ç©ºæ‰€æœ‰</button>
        </div>
    </script>

    <script type="text/html" id="alertBar">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</a>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.js"></script>
    <script>
        // APIåŸºç¡€è·¯å¾„
        const ALERT_API_BASE = '/api/alerts';
        const USER_API_BASE = '/api/users';

        // åˆå§‹åŒ–Layuiç»„ä»¶
        layui.use(['element', 'table', 'form', 'layer', 'laydate'], function(){
            var element = layui.element;
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var laydate = layui.laydate;

            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            laydate.render({
                elem: '#dateRange',
                range: true,
                theme: '#448aff'
            });

            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            document.addEventListener('DOMContentLoaded', function() {
                checkLoginStatus();
                initAlertTable();
            });

            // ç›‘å¬æœç´¢æäº¤
            form.on('submit(searchSubmit)', function(data){
                reloadAlertTable(data.field);
                return false;
            });
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${USER_API_BASE}/status`);
                const result = await response.json();

                if (result.success) {
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    document.getElementById('currentUserName').textContent = result.data.username;
                } else {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                // è·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            }
        }

        // ç”¨æˆ·ç™»å‡º
        async function logout() {
            try {
                const response = await fetch(`${USER_API_BASE}/logout`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // ç™»å‡ºæˆåŠŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                } else {
                    alert('ç™»å‡ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ç™»å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–å‘Šè­¦è¡¨æ ¼
        function initAlertTable() {
            layui.table.render({
                elem: '#alertTable',
                url: `${ALERT_API_BASE}/records`, // æ•°æ®æ¥å£
                toolbar: '#alertToolbar',
                cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'fundCode', title: 'åŸºé‡‘ä»£ç ', width: 120, sort: true},
                    {field: 'fundName', title: 'åŸºé‡‘åç§°', minWidth: 150},
                    {field: 'alertType', title: 'å‘Šè­¦ç±»å‹', width: 120, templet: function(d) {
                        switch(d.alertType) {
                            case 'HIGH': return '<span class="alert-high">é«˜é£é™©</span>';
                            case 'MEDIUM': return '<span class="alert-medium">ä¸­é£é™©</span>';
                            case 'LOW': return '<span class="alert-low">ä½é£é™©</span>';
                            default: return d.alertType;
                        }
                    }},
                    {field: 'ruleDescription', title: 'è§„åˆ™æè¿°', minWidth: 200},
                    {field: 'alertContent', title: 'å‘Šè­¦å†…å®¹', minWidth: 200},
                    {field: 'createTime', title: 'å‘Šè­¦æ—¶é—´', width: 180, sort: true},
                    {fixed: 'right', title: 'æ“ä½œ', toolbar: '#alertBar', width: 80}
                ]],
                page: true,
                limit: 10,
                limits: [10, 20, 30, 50],
                request: {
                    pageName: 'page', // é¡µç çš„å‚æ•°åç§°ï¼Œé»˜è®¤ï¼špage
                    limitName: 'size' // æ¯é¡µæ•°æ®é‡çš„å‚æ•°åï¼Œé»˜è®¤ï¼šlimit
                },
                response: {
                    statusCode: 200 // é‡æ–°è§„å®šæˆåŠŸçš„çŠ¶æ€ç ä¸º 200ï¼Œtable ç»„ä»¶é»˜è®¤ä¸º 0
                },
                parseData: function(res){ // å°†åŸå§‹æ•°æ®è§£ææˆ table ç»„ä»¶æ‰€è§„å®šçš„æ•°æ®
                    return {
                        "code": res.code, // è§£ææ¥å£çŠ¶æ€
                        "msg": res.message, // è§£ææç¤ºæ–‡æœ¬
                        "count": res.data.totalElements, // è§£ææ•°æ®é•¿åº¦
                        "data": res.data.content // è§£ææ•°æ®åˆ—è¡¨
                    };
                }
            });
        }

        // é‡æ–°åŠ è½½å‘Šè­¦è¡¨æ ¼
        function reloadAlertTable(params) {
            layui.table.reload('alertTable', {
                where: params,
                page: {
                    curr: 1 // é‡æ–°ä»ç¬¬ 1 é¡µå¼€å§‹
                }
            });
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            layui.table.reload('alertTable');
        }

        // æ¸…ç©ºæ‰€æœ‰å‘Šè­¦
        function clearAllAlerts() {
            layer.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å‘Šè­¦è®°å½•å—ï¼Ÿ', {
                title: 'æç¤º',
                icon: 3
            }, function(index){
                layer.msg('æ¸…ç©ºåŠŸèƒ½å¼€å‘ä¸­...', {icon: 1});
                layer.close(index);
            });
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            layer.msg('å¯¼å‡ºæ•°æ®åŠŸèƒ½å¼€å‘ä¸­...', {icon: 1});
        }
    </script>
</body>
</html>